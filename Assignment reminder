import json
import datetime
import time
import os

# --- Configuration ---
DATA_FILE = 'assignments.json'
REMINDER_THRESHOLD_DAYS = 3 # How many days before the due date to start reminding

# --- File Handling Functions ---

def load_assignments():
    """Loads assignments from the JSON file."""
    if not os.path.exists(DATA_FILE):
        return []
    try:
        with open(DATA_FILE, 'r') as f:
            return json.load(f)
    except json.JSONDecodeError:
        print(f"‚ö† Error: Could not decode JSON from {DATA_FILE}. Starting with an empty list.")
        return []
    except Exception as e:
        print(f"‚ö† An error occurred while loading: {e}. Starting with an empty list.")
        return []

def save_assignments(assignments):
    """Saves assignments to the JSON file."""
    try:
        with open(DATA_FILE, 'w') as f:
            json.dump(assignments, f, indent=4)
    except Exception as e:
        print(f"‚ùå Error saving data: {e}")

# --- Core Logic Functions ---

def check_reminders(assignments):
    """Checks for assignments due soon and prints a reminder."""
    now = datetime.datetime.now()
    due_assignments = []
    
    print("\n--- Checking Reminders ---")
    
    if not assignments:
        print("‚úÖ No assignments currently tracked.")
        return

    for assignment in assignments:
        try:
            # Convert the due_date string to a datetime object
            due_date_str = assignment['due_date']
            due_date = datetime.datetime.strptime(due_date_str, "%Y-%m-%d %H:%M:%S")
            
            time_left = due_date - now
            time_left_days = time_left.total_seconds() / (60 * 60 * 24)

            # Check if the assignment is due and within the reminder threshold
            if time_left_days <= REMINDER_THRESHOLD_DAYS and time_left_days > 0:
                due_assignments.append({
                    "name": assignment['name'],
                    "time_left": f"{time_left.days} days, {time_left.seconds // 3600} hours",
                    "priority": assignment['priority'],
                    "due_date_full": due_date_str
                })
            
            # Check for overdue assignments
            elif time_left_days <= 0:
                print(f"üö® *OVERDUE:* {assignment['name']} (Due: {due_date_str})")


        except ValueError:
            print(f"‚ùó Invalid date format for '{assignment['name']}'. Please use YYYY-MM-DD HH:MM:SS.")
            continue
        
    if due_assignments:
        print("\nüîî *Assignments Due Soon:*")
        # Sort by the time left (ascending)
        due_assignments.sort(key=lambda x: datetime.datetime.strptime(x['due_date_full'], "%Y-%m-%d %H:%M:%S"))
        for item in due_assignments:
            print(f"  - *{item['name']}* (Priority: {item['priority']}) -> *{item['time_left']} left!*")
    else:
        print("‚úÖ No assignments are due within the next {} days.".format(REMINDER_THRESHOLD_DAYS))

def add_assignment(assignments):
    """Prompts the user to add a new assignment."""
    print("\n--- Add New Assignment ---")
    name = input("Assignment Name: ")
    # Input format: YYYY-MM-DD HH:MM:SS
    date_format = "%Y-%m-%d %H:%M:%S"
    due_date_str = input(f"Due Date (e.g., 2025-11-25 23:59:00): ")
    priority = input("Priority (e.g., High, Medium, Low): ")
    
    try:
        # Validate the date format
        datetime.datetime.strptime(due_date_str, date_format) 
        
        new_assignment = {
            "name": name,
            "due_date": due_date_str,
            "priority": priority
        }
        assignments.append(new_assignment)
        save_assignments(assignments)
        print("‚ûï Assignment added successfully!")
        
    except ValueError:
        print(f"‚ùå Invalid date format entered. Please use {date_format}.")

# --- NEW FUNCTION FOR DELETION ---

def delete_assignment(assignments):
    """Lists assignments and allows the user to delete one by index."""
    if not assignments:
        print("\n‚Ñπ No assignments to delete.")
        return

    print("\n--- Delete/Complete Assignment ---")
    print("Select the number of the assignment to mark as COMPLETE and remove:")

    # 1. List all assignments with an index
    for i, assignment in enumerate(assignments):
        print(f"  [{i+1}] {assignment['name']} (Due: {assignment['due_date']} | Priority: {assignment['priority']})")
    
    try:
        choice = input("Enter number to delete, or 'C' to cancel: ").strip()
        
        if choice.lower() == 'c':
            print("Operation cancelled.")
            return

        index_to_delete = int(choice) - 1
        
        # 2. Validate index
        if 0 <= index_to_delete < len(assignments):
            deleted_assignment = assignments.pop(index_to_delete)
            save_assignments(assignments)
            print(f"‚úÖ Assignment *'{deleted_assignment['name']}'* marked as complete and removed!")
        else:
            print("‚ùå Invalid number entered. Please choose a number from the list.")
            
    except ValueError:
        print("‚ùå Invalid input. Please enter a number or 'C'.")
    except Exception as e:
        print(f"An unexpected error occurred: {e}")


# --- User Interaction Function ---

def display_menu():
    """Displays the main menu options."""
    print("\n===============================")
    print("üéì Assignment Reminder System üóì")
    print("===============================")
    print("1. Check Reminders Now")
    print("2. Add New Assignment")
    print("3. View All Assignments (Detail)")
    print("4. Delete/Complete Assignment")
    print("5. Exit")
    print("===============================")

def view_all_assignments(assignments):
    """Prints a detailed list of all assignments."""
    print("\n--- All Tracked Assignments ---")
    if not assignments:
        print("‚Ñπ No assignments are currently being tracked.")
        return

    for assignment in assignments:
        print(f"* *{assignment['name']}*")
        print(f"  - Due: {assignment['due_date']}")
        print(f"  - Priority: {assignment['priority']}")
        print("-" * 20)


# --- Main Program Loop ---

def main():
    assignments = load_assignments()
    
    # Optional: Initial check on startup
    check_reminders(assignments) 
    
    while True:
        display_menu()
        choice = input("Enter your choice (1/2/3/4/5): ")
        
        if choice == '1':
            check_reminders(assignments)
        elif choice == '2':
            add_assignment(assignments)
        elif choice == '3':
            view_all_assignments(assignments)
        elif choice == '4':
            # Handle the new deletion function
            delete_assignment(assignments)
        elif choice == '5':
            print("üëã Exiting the system. Goodbye!")
            break
        else:
            print("‚ùó Invalid choice. Please select 1, 2, 3, 4, or 5.")
        
        # Pause for a short time to make the output readable before the next loop
        time.sleep(1) 

if _name_ == "_main_":
¬†¬†¬†¬†main()
